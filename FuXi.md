[TOC]

# **《FuXi‐En4DVar: An Assimilation System Based on Machine Learning Weather Forecasting Model Ensuring Physical Constraints》**

[《FuXi‐En4DVar：一种基于机器学习天气预报模型并保持物理一致性的数据同化系统》](https://agupubs.onlinelibrary.wiley.com/doi/10.1029/2024GL111136)
---
##  主要创新
-  **自动微分替代伴随模式**：通过 PyTorch 的自动微分计算梯度，**避免了传统 NWP 中繁琐的切线线性与伴随模型**构建；
-  **快速集合生成**：利用基于机器学习的天气预报模型的迅速集成能力，**构建背景误差协方差矩阵**。利用 ML 模型的高速推理能力，通过 Perlin noise 生成 200 组集合成员；
-  **物理平衡约束**：在代价函数最小化中保持地转平衡等气象动力学关系；
-  **流依赖性（Flow-dependent）**：同化信息可随天气流场传播，符合时间演化规律，**限制了维持物理平衡关系的分析增量**。

---

##  一、研究背景与意义

随着机器学习（ML）气象预报模型（如 FuXi、FourCastNet、GraphCast、FengWu 等）的发展，天气预报的速度与精度显著提升，但这些模型仍然依赖**传统数值天气预报（NWP）系统的数据同化DA**来生成初始场。这意味着：
-  ML 模型无法独立进行预报；
-  传统 DA 的初始场不一定最适合 ML 模型；
-  缺乏物理约束的 ML 同化方法可能导致分析场失衡。

为了解决上述问题，作者提出了一个**基于 FuXi 模型的机器学习四维集合变分同化系统（FuXi‐En4DVar）**，使 ML 模型能够**独立生成物理一致的分析场**。

---

## 二、FuXi‐En4DVar 系统核心方法

FuXi‐En4DVar 将 **FuXi 模型（ML 预报模型）** 与 **Ensemble 4DVar 同化算法** 融合：

1️⃣ **自动微分计算梯度，替代伴随模型**
-  由于 FuXi 是深度学习模型（基于 PyTorch），其传播算子是可微的，直接用 **自动微分 (Automatic Differentiation, AD)** 技术求取梯度
- 采用 **L-BFGS**（准牛顿法）在控制变量空间 𝑤 上求最优解
- 效果：免去伴随模式开发；化系统可直接嵌入任何可微 ML 模型；同化优化迭代更快、实现更简洁

2️⃣ **ML 快速集合生成构建背景误差协方差矩阵**
- 传统 4DVar 的背景误差协方差矩阵 𝐵 一般是静态的，不能反映随天气演变的流依赖特征。En4DVar 则通过集合成员（Ensemble）估计动态 𝐵，但生成高质量集合成本很高
- 做法：利用 FuXi 模型快速推理能力（仅需毫秒级） 来生成集合：
    - 在初始时刻（ERA5 数据）前 6 小时生成 200 组 **Perlin noise**；
    - 将噪声叠加到背景场中，形成 200 组扰动初值；
    - 每个扰动初值经 FuXi 预报一步（6 小时）得到集合成员；
    - 由此计算 B
    - 通过**局地化 (Localization)** 降低集合中伪相关问题
- 效果：B 矩阵具有时变流依赖特征、降低了集合生成的计算成本（得益于 ML 模型的高速度）、同化增量随天气形势合理传播

3️⃣ **代价函数的机器学习化重构**

4DVar 代价函数：

$$
    J(x) = 
    \frac{1}{2}(x - x_b)^{T} B^{-1} (x - x_b) 
    + \frac{1}{2} \sum_{i=0}^{n} 
    \left[ y_i - H_i \left( M_i(x) \right) \right]^{T} 
    R_i^{-1} 
    \left[ y_i - H_i \left( M_i(x) \right) \right]
    $$



FuXi-En4DVar 重构：
 
$$
    \begin{aligned}
    J(w) = &
    \frac{1}{2} w^{T} w 
    + \frac{1}{2} 
    \left( y_{0} - H_{0}(x_b + X_b w) \right)^{T} 
    R_{0}^{-1} 
    \left( y_{0} - H_{0}(x_b + X_b w) \right) \\
    & + \frac{1}{2} 
    \left( y_{6} - H_{6} \left( M_{6}(x_b + X_b w) \right) \right)^{T} 
    R_{6}^{-1} 
    \left( y_{6} - H_{6} \left( M_{6}(x_b + X_b w) \right) \right)
    \end{aligned}
    $$

- 由于 FuXi 模型时间步为 6 小时，作者定义一个两时刻的 assimilation window（如最下面J（w））：
- 将传统的动力学传播 Mt 用 FuXi 网络推理模块替代；
- 代价函数的物理意义不变，但完全基于可微神经网络实现；
- 优化目标变为：寻找控制变量 𝑤 使分析场在背景与观测之间达到最优平衡。

效果：融合 ML 预测模型与 DA、保持 4DVar 的理论一致性

4️⃣ **保持物理约束的设计与验证**
- 纯 ML 同化或端到端学习往往忽略物理平衡（如地转平衡、能量守恒），导致分析场不稳定。
- FuXi-En4DVar 的做法
    - 在代价函数最小化时显式利用 流依赖 B 矩阵 来传播各物理量间的协方差（如位势高度与风场的关联）；
    - 通过实验验证分析增量符合地转平衡：
      - Z500 正异常伴随反气旋风场；
      - 垂直方向 v 风分布亦符合反气旋结构；
  - 说明系统在同化过程中自发保持物理一致性，无需额外显式约束。
- 效果：分析场物理平衡；观测信息能合理地随流场传播；显著优于之前的 ML-DA（如 FengWu-4DVar、FuXi-DA）。

---

## 三、实验设计与主要结果

**实验设计**

四组实验验证系统性能（数据基于 ERA5）：

| 实验    | 同化内容                          | 目的             |
| ----- | ----------------------------- | -------------- |
| EXP_1 | 单点 Z500                       | 检验物理平衡约束（地转平衡） |
| EXP_2 | 单点 R500（不同时间）                 | 验证时间传播能力（流依赖性） |
| EXP_3 | 区域多变量（T500, U500, V500, R500） | 验证多点同化与梯度计算有效性 |
| EXP_4 | 多层多变量（250–1000 hPa）           | 模拟实际观测条件的综合验证  |

**主要结果：**
1. **物理平衡性（EXP_1）**
   - 同化后的分析增量符合地转平衡：Z500 正异常伴随反气旋环流；
   - 垂直方向也出现一致的风场调整；
   -  说明系统在空间与垂直方向上均能保持物理约束。

2. **观测信息传播（EXP_2）**
   - 单点观测在时间窗口内可沿背景流场传播；
   - 同化结束时的增量分布与风场一致，体现出系统的**流依赖性与时序一致性**。

3. **系统有效性（EXP_3 & EXP_4）**
   - 自动微分计算的梯度与伴随法结果一致；
   - 代价函数 ( J ) 收敛合理；
   - 同化后 OMA（观测-分析差）显著小于 OMB（观测-背景差）；
   - RMSE 相对背景场显著降低（多数变量改善 >10%）；
   - 没有明显的虚假相关。
---

## 四、结论与展望

**主要结论**

- **FuXi‐En4DVar** 实现了 ML 模型的自主同化系统；
- 保证了分析场的**物理平衡**和**时间演化一致性**；
- 可独立生成高质量初始场，减少对传统 NWP 的依赖；
- 验证了自动微分法在同化优化中的可行性与高效性。
  
**局限与未来方向**
- 使用 Perlin noise 生成集合成员时存在伪相关，需优化；
- 实验使用 ERA5 数据，缺乏真实观测数据验证；
- 观测算子与误差矩阵 ( R ) 仍较简单；
- 未来将：
  - 利用深度学习改进集合生成与 ( B ) 矩阵构造；
  - 引入卫星、雷达等非传统观测；
  - 探索端到端 ML 同化与预报系统，最终取代传统 NWP。
---

# **《FUXI-DA: A GENERALIZED DEEP LEARNING DATA ASSIMILATION FRAMEWORK FOR ASSIMILATING SATELLITE OBSERVATIONS》**
[《FUXI-DA: 一种通用深度学习卫星观测数据同化框架》](https://arxiv.org/abs/2404.08522)
---
##  主要创新
FUXI-DA 是面向深度学习天气预报模型的通用数据同化框架，旨在打破传统NWP系统对深度学习模型的依赖，实现独立同化与预报一体化。  
其核心创新体现在以下四个方面：
1. **双编码器结构**：为解决背景数据与观测数据之间信息含量的差异，FuXi-DA采用独立编码器分别处理两类数据。不同类型的数据采用不同的编码器。分别处理背景场与卫星观测数据，自动对齐特征空间；
2. **免误差矩阵的融合神经网络**：传统数据同化方法需要估计观测和背景误差协方差矩阵，FuXi-DA通过一种创新的统一融合神经网络避免了这一需求。够有效灵活地调整观测与背景数据的权重，而无需估计它们的误差协方差矩阵。
3. **隐式数据预处理步骤**：观测数据的预处理涉及大量繁琐工作，包括数据稀疏化、云检测、偏差校正等。FuXi-DA无需数据稀疏化和云检测操作，从而最大化利用观测数据；在FuXi-DA的输入中加入了卫星天顶角和时空信息，并在融合模块内调整观测以实现偏差校正功能，自动学习观测偏差与云干扰特征；
4. **同化-预报联合训练框架**：支持将数据同化与任意基于深度学习的天气预报模型进行联合训练，该方法将预报优化窗口扩展至传统同化窗口之外。**利用中期预报的监督信息**，将中期预报误差信息纳入同化优化，实现同化与预报过程的统一优化。
---

## 一、研究背景与意义

**研究背景**

**深度学习与数据同化（Data Assimilation, DA）** 相结合的现有研究主要集中在：
- **简化模型验证阶段**（如 Lorenz-63、Lorenz-96、二维浅水方程）；
- **传统同化系统的部分模块替代**（如误差估计或观测算子学习）。

这些方法虽验证了可行性，但仍**依赖传统数值天气预报（NWP）系统生成的分析场**，缺乏真正适用于深度学习天气模型的独立同化系统

**研究意义**

FUXI-DA 的提出旨在构建：
- 一个 **可直接处理卫星观测数据** 的深度学习同化系统；
- 一个 **独立于传统NWP模型** 的深度学习天气业务框架；
- 一个能够 **联合优化同化与预报** 的端到端学习体系。
- 为未来的“纯深度学习气象系统”奠定了基础。

---

## 二、系统核心方法

**总体架构**

FUXI-DA 由三大部分组成：
1. **背景场编码器（Background Encoder）**  
   - 输入：由深度学习天气模型（如 FuXi）产生的背景预报场；
   - 功能：提取背景态特征，保留动态结构信息。
2. **观测编码器（Observation Encoder）**  
   - 输入：卫星辐射计（如 FY-4B AGRI）观测数据；
   - 功能：编码多通道辐射观测信息，考虑时空分布与卫星天顶角；
   - 可隐式学习观测偏差与云干扰特征；
   - 支持不同类型卫星观测（红外、微波等）。
3. **融合网络（Fusion Network）**  
   - 输入：背景与观测的编码结果；
   - 核心：一种统一融合神经网络（Unified Fusion Net），自适应调整背景与观测的权重；
   - 输出：优化后的分析场（Analysis）。

**机制详述**

1️⃣ **双编码器异构输入结构**
- 背景数据和观测数据存在信息量与分辨率差异；
- FuXi-DA 使用独立编码器分别提取它们的语义特征；
- 通过统一融合模块在特征空间中完成动态配准。

2️⃣ **融合网络替代误差协方差矩阵**
传统 DA 依赖误差协方差矩阵 \( B, R \)，而 FUXI-DA 通过端到端训练的融合网络隐式学习：
\[
\text{Analysis} = \text{Fusion}(E_b(x_b), E_o(y))
\]
无需显式估计 \( B^{-1} \) 和 \( R^{-1} \)，从而：
- 避免误差矩阵计算和存储负担；
- 自动平衡背景与观测的权重；
- 提高同化效率与灵活性。

3️⃣ **隐式隐式数据预处理步骤：偏差校正与云影响学习**
- 输入中显式引入卫星天顶角、时间、经纬度等；
- 模型自动学习辐射观测偏差；
- 历史训练数据中包含云干扰样本，使网络隐式学习“云影响修正”；
- FuXi-DA具备自主云检测能力，不再需要人工的云检测与稀疏化预处理。

4️⃣ **同化与预报的联合优化**
- 与 FuXi 预报模型端到端联合训练；
- 损失函数不仅包含同化误差，还包括**未来多个时间步的预报误差**；
- 优化目标扩展至传统同化窗口之外，实现：
  > “Assimilation improves forecast, forecast guides assimilation.”

此策略显著提升了中期预报性能（>10% RMSE 改善）。

---

## 三、实验与结果

**实验设计**
- **数据来源：** 风云四号B星（FY-4B）搭载的先进静止轨道辐射成像仪（AGRI）；
- **实验组：**
  - **FUXI-DA**（同化 AGRI 数据）；
  - **Control**（结构相同但不含卫星同化模块）。
- **训练方式：** 使用 ERA5 及 AGRI 数据进行联合训练；
- **验证指标：** RMSE、Anomaly Correlation Coefficient（ACC）、Bias。

**主要结果**
- **卫星同化显著提升预报精度：**
  - 各层气温、湿度、风场 RMSE 均降低；
  - ACC 提高 5%~15%；
- **偏差校正效果突出：**
  - 模型成功修正 AGRI 辐射通道偏差；
  - 在云区保持分析稳定；
- **同化带来的改进持续至中期预报阶段：**
  - 在 48h~72h 预报中，FUXI-DA 结果持续优于基线模型；
- **消融实验验证：**
  - 移除卫星输入或天顶角信息后性能显著下降；
  - 证明偏差校正与异构编码的重要性。

---

## 四、结论与展望

**主要结论**
- FUXI-DA 实现了 **通用深度学习数据同化框架**；
- 通过双编码器 + 融合网络结构，实现了观测与背景的**高效融合**；
- 省去误差协方差矩阵估计，显著简化同化流程；
- 与深度学习天气模型（FuXi）端到端训练，实现**同化-预报一体化优化**；
- 成功应用于真实卫星观测（FY-4B AGRI），验证其实用价值。

**局限与未来展望**
- 当前仅验证 AGRI 辐射观测数据；
- 未来计划：
  - 引入多源卫星观测（红外、微波、成像仪等）；
  - 探索稀疏观测数据（探空、飞机报）在深度学习同化中的应用；
  - 联合模拟与真实观测进行混合训练；
  - 构建端到端的深度学习气象预报系统，实现完全独立于NWP的业务化框架。
---

# **《FuXi-ENS: A machine learning model for medium-range ensemble weather forecasting》**
[《FuXi-ENS：一种用于中尺度集合天气预报的机器学习模型》](https://arxiv.org/abs/2405.05925)
---
## 主要创新

- **高分辨率全球集合预报**：首次实现 **0.25°（~28 km）空间分辨率**、**6 小时时间分辨率**、**15 天预报时效** 的 ML 集合预报系统。
- **端到端独立生成**：**无需依赖 ERA5 EDA 或业务集合成员**（如 GEFS），仅需一个实时分析场即可启动，具备业务部署潜力。
- **创新损失函数**：首次在 VAE 框架中用 **CRPS + KL 散度** 替代 **VAE 传统L1 + KL**，直接优化概率预报质量。
- **流依赖扰动机制**：在**初始条件和每个预报步**均引入扰动，模拟 NWP 中对“初始误差”和“物理倾向误差”的处理。
- **超高效率**：单成员 15 天预报仅需 **~10 秒**（A100 GPU），远快于传统 NWP。

---

## 一、引言

**集合预报背景**
天气预报本质上具有不确定性，这源于大气系统的高度非线性与**混沌特性**——微小的初始误差会随时间指数增长，导致预报可信度随预报时效迅速下降。因此，仅提供单一“确定性”预报（如 ECMWF 的 HRES）往往不足以支撑高风险决策。集合预报（Ensemble Forecasting）通过生成多个略有差异的预报成员，量化不确定性，已成为现代气象业务的核心手段。

**传统集合预报的实现方式**
主流数值天气预报中心（如 ECMWF、NCEP）采用以下策略构建集合：
- 初始扰动：使用**奇异向量（Singular Vectors, SV）**或**集合数据同化（EDA）识别**对误差最敏感的初始场方向，施加**流依赖扰动**；
- 模型扰动：通过**随机物理参数化（如 SPPT）**模拟次网格过程的不确定性；
- 代价：计算开销巨大，全球主要预报中心的集合预报成员数限制在14至51个之间。

**ML 相关方法：**
- ML+确定性预报：重点是最小化平均绝对误差（MAE）或均方根误差（RMSE）等误差，限制了对预报不确定性的评估
- 使用随机Perlin噪声扰动初始条件：扰动与背景流无关，导致后期集合离散度不足。
- **GenCast**：基于扩散模型，通过对时空潜在天气情景的联合概率分布进行采样来生成集合预报。使用 **ERA5 + ERA5 EDA**（10 成员）训练，但 **EDA 非实时**，限制业务应用；分辨率为 0.25°，但时间分辨率为 12h。
- **SEEDS**：利用全球集合预报系统（GEFS）2个成员扩展生成大规模集合，但仅含 **8 个变量**、**2° 分辨率**，且依赖外部 NWP 系统。SEEDS包含两个模型：
  - 生成式集合模拟（SEEDS-GEE）模型，用于模拟GEFS的分布
  - 生成式后处理（SEEDS-GPP）模型，通过整合GEFS和ERA5 EDA的分布来校正GEFS中的偏差
- **LEF**（滞后集合）：通过历史预报构建集合，**无需训练**，但成员数受限、多样性不足。
- **SwinVRNN / FuXi-S2S**：基于 VAE，**在其损失函数中结合了重建损失和Kullback–Leibler（KL）散度**，**在潜空间加扰动生成集合**，但前者分辨率仅 5.625°，后者聚焦次季节尺度。
```
VAE（变分自编码器，Variational Autoencoder）：一种生成式深度学习模型，通过学习数据的概率分布来生成新样本。在天气预报中，可用于生成多个可能的未来天气情景（即“集合成员”），体现预报不确定性。
KL 损失（Kullback–Leibler Divergence）：衡量两个概率分布之间的差异。在 VAE 中，用于约束编码器输出的潜在分布接近标准正态分布，保证生成多样性。
```

FuXi-ENS 正是为克服上述方法在**分辨率、变量覆盖、实时性、扰动合理性**等方面的局限而设计。
- 结合了**连续排序概率评分（CRPS）和KL损失**，优于传统变分自编码器（VAE）模型中将L1损失与KL损失配对的使用方式
- 采用**分析数据和确定性模型进行初始化**，并辅以扰动模块，在初始化步骤及后续每个预报步骤中引入扰动
    - 在初始条件和每个预报步骤中引入扰动，扰动通过考虑初始条件和物理趋势中的误差，模拟了NWP模型中的集合生成过程

---

## 二、系统核心方法

- **模型架构**：自回归式 ML 模型，包含 **扰动模块**（VAE）和 **预报模块**（Swin Transformer 编码器-解码器）。
- **输入输出**：预测 **78 个变量**（5 大气变量 ×13 层 + 13 地表变量），输入为连续两时刻气象场。
- **扰动生成**：
  - 扰动模块将输入映射为高斯分布（μ, σ）；
  - 从该分布采样得到扰动初始场；
  - **每一步预报后重复此过程**，实现“预报中扰动”。
- **训练策略**：
  - 使用 **17 年 ERA5 再分析数据**（2002–2018）；
  - 损失函数：**LCRPS + λ·LKL**，其中 KL 项通过知识蒸馏对齐目标分布；
  - 采用课程学习（1→3 步自回归）。
- **初始化**：使用**分析场**（如 ECMWF operational analysis）作为输入，先生成确定性路径，再叠加扰动。

---

## 三、实验与结果

**1. 对比基准**：ECMWF 业务集合预报（51 成员，2018 年 0.25° 版本）。

**2. 确定性指标**（用于评估集合平均预报）：

评估指标：
- 均方根误差（RMSE）：RMSE量化预报误差的平均幅度，提供对准确 性的全面评估
- 异常相关系数（ACC）：ACC评估预测异常与观测异常之间的相关性，反映模型捕捉大尺度天气形势的能力

FuXi-ENS 在 **6 个关键变量**（Z500, T850, WS850, MSL, T2M, WS10M）上，**几乎全时段优于 ECMWF 集合均值**（除Z500和T850在60个预报时效中的 2个时次外，FuXi-ENS集合平均在几乎所有评估变量和预报时效上的RMSE更 低、ACC技巧更高）。

**3. 概率指标**（用于评估整个集合的不确定性表征能力）：

评估指标：
- **CRPS（Continuous Ranked Probability Score，连续分级概率评分）**：专门用于评估概率预报质量，衡量整个预测分布（由集合成员构成）与真实观测之间的“距离”，融合了可靠性（reliability）与分辨率（resolution），值越小越好，当集合退化为单点预报时，CRPS = MAE
- Ensemble Spread（集合离散度）：计算每个格点上所有集合成员的标准差，再求平均反映模型对不确定性的估计大小。理想情况下，离散度应随预报时效增长而增大。
- **SSR（Spread-Skill Ratio，离散度-技巧比）**：SSR = 集合离散度 / 集合平均 RMSE，判断集合是否“可靠”，衡量不确定性。离散度 ≈ 实际误差 → 可靠；离散度太小 → 欠离散，低估不确定性；SSR > 1：离散度太大 → 过离散（over-dispersive），高估不确定性

结果：
  - 在 **360 种变量-时效组合中，98.1% 的 CRPS 更优**；
  - SSR 更接近 1，表明**初始扰动更合理**，避免早期过/欠离散。

**4. 极端事件**：

评估指标：**Brier Score(BS)**

  - **热带气旋路径预报**：FuXi-ENS 的累积位置误差和离散度均小于 ECMWF，且方向/速度偏差更小；
  - **2018 东北亚热浪**：成功捕捉大尺度环流异常（Z500 高压），T2M 预报与 ECMWF 相当。
- **效率**：48 成员 15 天预报可在 **8×A100 GPU 上数分钟内完成**。

---

## 四、结论与展望

FuXi-ENS 首次证明：**纯数据驱动的 ML 模型可在高分辨率下全面超越世界领先 NWP 集合系统**，同时具备极低计算成本。其核心突破在于**合理的扰动机制**与**面向概率预报的损失设计**。

未来方向包括：
- 拓展至**次季节-季节尺度**预报；
- 应用于**集合数据同化**（提供低成本大集合）；
- 支撑**可再生能源、灾害预警**等高价值场景；
- 探索**多模态观测直接同化**，进一步摆脱对分析场的依赖。

该工作标志着 ML 在**不确定性量化**这一气象核心难题上取得实质性进展。